rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is super admin
    function isSuperAdmin() {
      return isAuthenticated() && (
        request.auth.uid == 'sxcToczAAwT3Fmh8FPXa1P6hMHB3' || 
        request.auth.token.email == 'thorarinnhjalmarsson@gmail.com' ||
        request.auth.token.email == 'thorarinnhjalm@gmail.com'
      );
    }
    
    // GLOBAL ADMIN BYPASS
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }
    
    // Helper function to check if user is manager of the house
    function isHouseManager(houseId) {
      return isAuthenticated() && 
        request.auth.uid == get(/databases/$(database)/documents/houses/$(houseId)).data.manager_id;
    }
    
    // Helper function to check if user is owner/member of the house
    function isHouseMember(houseId) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/houses/$(houseId)).data.owner_ids.hasAny([request.auth.uid]);
    }
    
    // Users Collection
    match /guest_views/{token} {
      allow read: if true;
      allow write: if isSuperAdmin() || request.auth != null; 
    }
    
    match /users/{userId} {
      // Users can read and write their own document
      // Super admin can read and write all user documents
      allow read: if isSuperAdmin() || isAuthenticated(); 
      allow write: if isSuperAdmin() || (isAuthenticated() && request.auth.uid == userId);
    }
    
    // Houses Collection
    match /houses/{houseId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Anyone authenticated can create a house (they become the manager)
      allow create: if isAuthenticated() && 
        request.resource.data.manager_id == request.auth.uid;
      
      // Allow reading basic info for invitations
      allow get: if true;
      
      // Members can read/list
      allow list: if isSuperAdmin() || (isAuthenticated() && resource.data.owner_ids.hasAny([request.auth.uid]));
      
      // Managers and Owners can update anything
      // BUT we also allow JOINING if you have the secret code
      allow update: if isSuperAdmin() || isHouseMember(houseId) || (
        isAuthenticated() && 
        request.resource.data.invite_code == resource.data.invite_code &&
        request.resource.data.owner_ids.hasAll(resource.data.owner_ids) &&
        request.resource.data.owner_ids.size() == resource.data.owner_ids.size() + 1 &&
        request.resource.data.owner_ids.hasAny([request.auth.uid])
      );
      allow delete: if isSuperAdmin() || isHouseManager(houseId);
    }
    
    // Bookings Collection
    match /bookings/{bookingId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Members can create bookings for their house
      allow create: if isSuperAdmin() || isHouseMember(request.resource.data.house_id);
      
      // Members can read bookings for their house
      allow read: if isSuperAdmin() || isHouseMember(resource.data.house_id);
      
      // Only the creator or manager can update/delete
      allow update, delete: if isSuperAdmin() || (isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        isHouseManager(resource.data.house_id)
      ));
    }
    
    // Budget Plans Collection
    match /budget_plans/{planId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Only manager can create/update budget plans
      allow create: if isSuperAdmin() || isHouseManager(request.resource.data.house_id);
      allow update: if isSuperAdmin() || isHouseManager(request.resource.data.house_id);
      
      // Members can read budget plans
      allow read: if isSuperAdmin() || isHouseMember(resource.data.house_id);
      
      // Only manager can delete
      allow delete: if isSuperAdmin() || isHouseManager(resource.data.house_id);
    }
    
    // Finance Entries Collection  
    match /finance_entries/{entryId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Only manager can create/update/delete finance entries
      allow create: if isSuperAdmin() || isHouseManager(request.resource.data.house_id);
      allow update: if isSuperAdmin() || isHouseManager(request.resource.data.house_id);
      allow delete: if isSuperAdmin() || isHouseManager(request.resource.data.house_id);
      
      // All members can read
      allow read: if isSuperAdmin() || isHouseMember(resource.data.house_id);
    }
    
    // Tasks Collection
    match /tasks/{taskId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Members can create tasks
      allow create: if isSuperAdmin() || isAuthenticated();
      
      // Members can read tasks for their house
      allow read: if isSuperAdmin() || isAuthenticated();
      
      // Members can update tasks
      allow update: if isSuperAdmin() || isAuthenticated();
      
      // Only manager can delete
      allow delete: if isSuperAdmin() || isAuthenticated();
    }
    
    // Guestbook Collection (Public + Admin)
    match /guestbook/{entryId} {
      allow create: if true;
      allow read: if true;
      allow update, delete: if isSuperAdmin() || isAuthenticated();
    }
    
    // Guest Access Collection
    match /guest_access/{accessId} {
      allow create: if isSuperAdmin() || isAuthenticated();
      allow read: if isSuperAdmin() || isAuthenticated();
      allow update, delete: if isSuperAdmin() || isAuthenticated();
    }
    
    // Shopping List Collection
    match /shopping_list/{itemId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Members can create shopping items
      allow create: if isSuperAdmin() || isHouseMember(request.resource.data.house_id);
      
      // Members can read items for their house
      allow read: if isSuperAdmin() || isHouseMember(resource.data.house_id);
      
      // Members can update (toggle checked status)
      allow update: if isSuperAdmin() || isHouseMember(resource.data.house_id);
      
      // Anyone can delete items from their house
      allow delete: if isSuperAdmin() || isHouseMember(resource.data.house_id);
    }
    
    // Internal Logs Collection (Owner Communication)
    match /internal_logs/{logId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Members can create logs
      allow create: if isSuperAdmin() || isHouseMember(request.resource.data.house_id);
      
      // Members can read logs for their house
      allow read: if isSuperAdmin() || isHouseMember(resource.data.house_id);
      
      // Only creator or manager can delete
      allow delete: if isSuperAdmin() || (isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        isHouseManager(resource.data.house_id)
      ));
    }
    
    // Contact Submissions Collection (from website contact form)
    match /contact_submissions/{submissionId} {
      allow read, write: if isSuperAdmin();
      allow create: if true;
    }
    
    // Invitations Collection
    match /invitations/{invitationId} {
      allow read: if true; // We filter by token in the frontend for security
      allow write: if isSuperAdmin();
    }
    
    // Coupons Collection (discount codes)
    match /coupons/{couponId} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated();
    }
    
    // Email Templates Collection
    match /email_templates/{templateId} {
      allow read, write: if isSuperAdmin();
      allow read: if true;
    }
    
    // Funnel Events Collection
    match /funnel_events/{eventId} {
      allow create: if isAuthenticated();
      allow read: if isSuperAdmin();
    }
    
    // Newsletter Subscribers Collection
    match /newsletter_subscribers/{subscriberId} {
      allow create: if true;
      allow read, write: if isSuperAdmin();
    }
  }
}
