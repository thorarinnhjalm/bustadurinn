rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is super admin
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.email == 'thorarinnhjalmarsson@gmail.com';
    }
    
    // Helper function to check if user is manager of the house
    function isHouseManager(houseId) {
      return isAuthenticated() && 
        request.auth.uid == get(/databases/$(database)/documents/houses/$(houseId)).data.manager_id;
    }
    
    // Helper function to check if user is owner/member of the house
    function isHouseMember(houseId) {
      return isAuthenticated() && 
        request.auth.uid in get(/databases/$(database)/documents/houses/$(houseId)).data.owner_ids;
    }
    
    // Users Collection
    match /guest_views/{token} {
      allow read: if true;
      allow write: if request.auth != null; // Only authed users (managers) can create views
    }
    
    match /users/{userId} {
      // Users can read and write their own document
      // Super admin can read and write all user documents
      allow read, write: if isSuperAdmin() || (isAuthenticated() && request.auth.uid == userId);
    }
    
    // Houses Collection
    match /houses/{houseId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Anyone authenticated can create a house (they become the manager)
      allow create: if isAuthenticated() && 
        request.resource.data.manager_id == request.auth.uid;
      
      // Allow reading basic info for invitations
      allow get: if true;
      
      // Members can read/list
      allow list: if isAuthenticated() && request.auth.uid in resource.data.owner_ids;
      
      // Managers and Owners can update anything
      // BUT we also allow JOINING if you have the secret code
      allow update: if isHouseMember(houseId) || (
        isAuthenticated() && 
        request.resource.data.invite_code == resource.data.invite_code &&
        request.resource.data.owner_ids.hasAll(resource.data.owner_ids) &&
        request.resource.data.owner_ids.size() == resource.data.owner_ids.size() + 1 &&
        request.auth.uid in request.resource.data.owner_ids
      );
      allow delete: if isHouseManager(houseId);
    }
    
    // Bookings Collection
    match /bookings/{bookingId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Members can create bookings for their house
      allow create: if isHouseMember(request.resource.data.house_id);
      
      // Members can read bookings for their house
      allow read: if isHouseMember(resource.data.house_id);
      
      // Only the creator or manager can update/delete
      allow update, delete: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        isHouseManager(resource.data.house_id)
      );
    }
    
    // Budget Plans Collection
    match /budget_plans/{planId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Only manager can create/update budget plans
      allow create: if isHouseManager(request.resource.data.house_id);
      allow update: if isHouseManager(resource.data.house_id);
      
      // Members can read budget plans
      allow read: if isHouseMember(resource.data.house_id);
      
      // Only manager can delete
      allow delete: if isHouseManager(resource.data.house_id);
    }
    
    // Finance Entries Collection  
    match /finance_entries/{entryId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Only manager can create/update/delete finance entries
      allow create: if isHouseManager(request.resource.data.house_id);
      allow update: if isHouseManager(resource.data.house_id);
      allow delete: if isHouseManager(resource.data.house_id);
      
      // All members can read
      allow read: if isHouseMember(resource.data.house_id);
    }
    
    // Tasks Collection
    match /tasks/{taskId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Members can create tasks
      allow create: if isAuthenticated();
      
      // Members can read tasks for their house
      allow read: if isAuthenticated();
      
      // Members can update tasks
      allow update: if isAuthenticated();
      
      // Only manager can delete
      allow delete: if isAuthenticated();
    }
    
    // Guestbook Collection
    match /guestbook/{entryId} {
      // Anyone can create a guestbook entry (including guests via magic link)
      allow create: if true;
      
      // Members can read guestbook entries
      allow read: if true;
      
      // Only the author or manager can update/delete
      allow update, delete: if isAuthenticated();
    }
    
    // Guest Access Collection
    match /guest_access/{accessId} {
      // Only manager can create guest access
      allow create: if isAuthenticated();
      
      // Members can read
      allow read: if isAuthenticated();
      
      // Only manager can update/delete
      allow update, delete: if isAuthenticated();
    }
    
    // Shopping List Collection
    match /shopping_list/{itemId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Members can create shopping items
      allow create: if isHouseMember(request.resource.data.house_id);
      
      // Members can read items for their house
      allow read: if isHouseMember(resource.data.house_id);
      
      // Members can update (toggle checked status)
      allow update: if isHouseMember(resource.data.house_id);
      
      // Anyone can delete items from their house
      allow delete: if isHouseMember(resource.data.house_id);
    }
    
    // Internal Logs Collection (Owner Communication)
    match /internal_logs/{logId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Members can create logs
      allow create: if isHouseMember(request.resource.data.house_id);
      
      // Members can read logs for their house
      allow read: if isHouseMember(resource.data.house_id);
      
      // Only creator or manager can delete
      allow delete: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        isHouseManager(resource.data.house_id)
      );
    }
    
    // Contact Submissions Collection (from website contact form)
    match /contact_submissions/{submissionId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Anyone can create (public contact form)
      allow create: if true;
    }
    
    // Coupons Collection (discount codes)
    match /coupons/{couponId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // Users can read active coupons to validate them
      allow read: if isAuthenticated();
    }
    
    // Email Templates Collection
    match /email_templates/{templateId} {
      // Super admin has full access
      allow read, write: if isSuperAdmin();
      
      // System can read templates for sending (via Cloud Functions)
      allow read: if true;
    }
  }
}
